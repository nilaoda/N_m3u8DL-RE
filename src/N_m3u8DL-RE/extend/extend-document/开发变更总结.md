# BatchDownload 插件开发变更总结

## 最新配置架构优化 (重要变更)

### 配置统一化重构
- **删除文件**: `BatchDownloadConfig.cs` - 移除了冗余的配置类
- **统一配置源**: 所有配置现在直接从 `PluginConfig.json` 读取
- **输入文件统一**: 使用统一的输入文件路径 `extend/BatchDownloadPlugin-and-input-output/input-batch-urls.txt`
- **消除冲突**: 解决了配置冲突问题，确保单一配置来源

### 配置解析方法优化
**在 BatchDownloadPlugin-and-input-output/BatchDownloadPlugin.cs 中新增直接JSON解析方法**:
- `private bool ExtractEnabledFromConfig()` - 提取启用状态
- `private bool ExtractCreateSubdirectoriesFromConfig()` - 提取子目录创建配置
- **优势**: 消除硬编码依赖，提高配置灵活性

**在 PluginManager.cs 中新增配置提取方法**:
- `private static bool ExtractBatchDownloadEnabledFromConfig()`
- **功能**: 为 Program.cs 提供统一的配置获取接口

### 插件检测逻辑优化
**在 Program.cs 中优化插件检测逻辑**:
- **移除**: 旧的反射配置获取方式 (`config?.BatchDownload`)
- **新增**: 使用 `ExtractBatchDownloadEnabledFromConfig()` 方法
- **修复**: 解决了"No URLs available"运行时错误
- **改进**: 插件实例获取逻辑更加稳定可靠

## 在 Program.cs 中的修改

### 在 [Program.cs] [800行附近] 中新增了 `GetUniqueFileNameFromUrl` 方法
**功能**: 根据URL和批量索引生成唯一文件名  
**参数**: string url, int batchIndex, int totalBatches  
**返回值**: string 格式为 {URL基础名}_batch{索引}_of_{总数}_{时间戳}

### 在 [Program.cs] [561行附近] 中新增了 `ExecuteBatchDownload` 方法  
**功能**: 执行批量下载逻辑  
**参数**: dynamic batchPlugin, MyOption option  
**返回值**: async Task

### 在 [Program.cs] [675行附近] 中修改了 `ExecuteSingleDownload` 函数
**新增参数**: 
- int batchIndex = 0: 批量索引
- int totalBatches = 0: 总批量数  
- bool batchDownload = false: 是否为批量下载模式

### 在 [Program.cs] [624-626行附近] 中修改了批量下载循环逻辑
**新增**: option.SaveName = null; 确保每个URL生成唯一文件名

### 在 [Program.cs] [261-344行附近] 中新增了批量下载插件检测逻辑 (已优化)
**优化内容**: 使用新的配置提取方法，提高检测可靠性

## 在 CommandLine/CommandInvoker.cs 中的修改

### 在 [CommandLine/CommandInvoker.cs] [34行附近] 中新增了 `BatchMode` 命令行选项
**新增**: private static readonly Option<bool> BatchMode = new("--batch")

### 在 [CommandLine/CommandInvoker.cs] [36行附近] 中修改了 `SaveDir` 选项
**修改**: 参数名从 --dir 改为 --save-dir

### 在 [CommandLine/CommandInvoker.cs] [617,632行附近] 中修改了 `GetOptions` 函数
**新增参数**:
- BatchMode = result.GetValue(BatchMode)
- SaveDir = result.GetValue(SaveDir)

### 在 [CommandLine/CommandInvoker.cs] [732行附近] 中修改了 `RootCommand` 配置
**新增**: 将 BatchMode 和 SaveDir 添加到根命令选项中

## 在 CommandLine/MyOption.cs 中的修改

### 在 [CommandLine/MyOption.cs] [18行附近] 中新增了 `BatchMode` 属性
**新增**: public bool BatchMode { get; set; }

## 在 N_m3u8DL-RE.csproj 中的修改

**无修改** - 批量下载功能作为插件扩展添加，无需修改主项目配置

## 在 Downloader/SimpleDownloader.cs 中的修改

**无修改** - 批量下载功能主要涉及程序逻辑层，不需要修改下载器组件

## BatchDownloadPlugin 调用链

```
Main() → 检测批量模式 → ExecuteBatchDownload() → 循环处理URL列表 → 
ExecuteSingleDownload(url, option, batchIndex, totalBatches, batchDownload=true) → 
GetUniqueFileNameFromUrl() → 生成唯一文件名 → 执行下载
```

## 参数传递链

```
命令行参数 --batch --save-dir → MyOption.BatchMode + MyOption.SaveDir → 
ExecuteBatchDownload() → ExecuteSingleDownload() → 
GetUniqueFileNameFromUrl() → option.SaveName → 文件写出
```

## 批量下载使用方法

```bash
# 基本用法
dotnet run -- --batch --save-dir /workspace/mpegts.js/demo/output

# 带详细日志
dotnet run -- --batch --save-dir /output --log-level debug
```

**输入文件**: `略/extend/BatchDownloadPlugin-and-input-output/input-batch-urls.txt` (每行一个URL)  
**输出格式**: `{URL基础名}_batch{索引}_of_{总数}_{时间戳}.{扩展名}`  
**示例文件名**: `7d7157190fe28708-9c54c7045ab91221e04441539478c65f-hls_720p_2_batch01_of_02_2025-12-15_03-27-14.mp4`