# N_m3u8DL-RE 模块功能详细说明

## 项目模块概览

N_m3u8DL-RE 采用模块化设计，将功能划分为4个主要项目模块，每个模块有明确的职责边界。

## 1. 主程序模块 (N_m3u8DL-RE)

### 1.1 程序入口 (Program.cs)
**文件位置:** `/workspace/N_m3u8DL-RE-src/src/N_m3u8DL-RE/Program.cs`
**代码行数:** 19260行

**核心功能:**
- 程序启动和初始化
- 命令行参数解析和处理
- 全局配置和设置
- 主工作流程控制
- 错误处理和用户交互

**关键函数:**
- `Main()` - 程序入口点
- `DoWorkAsync()` - 核心工作流程
- `Console_CancelKeyPress()` - 中断处理
- `CheckUpdateAsync()` - 版本检查

### 1.2 命令行模块 (CommandLine/)

#### CommandInvoker.cs
**功能:** 命令行参数调用器
- 解析命令行参数
- 验证参数有效性
- 调用相应的处理函数

#### ComplexParamParser.cs  
**功能:** 复杂参数解析器
- 处理键值对参数
- 解析自定义格式参数
- 参数转换和验证

#### MyOption.cs
**功能:** 选项配置类
- 定义所有命令行选项
- 参数默认值设置
- 参数约束验证

### 1.3 下载管理器 (DownloadManager/)

#### SimpleDownloadManager.cs
**功能:** 点播下载管理器
- 管理点播流下载流程
- 协调多个下载任务
- 处理下载进度和状态

#### HTTPLiveRecordManager.cs
**功能:** HTTP直播录制管理器
- 专门处理HTTP直播流
- 实时监控流状态
- 分段录制和合并

#### SimpleLiveRecordManager2.cs
**功能:** 普通直播录制管理器
- 处理普通直播流录制
- 支持实时转码
- 录制质量控制

### 1.4 下载器接口 (Downloader/)

#### IDownloader.cs
**功能:** 下载器接口定义
```csharp
public interface IDownloader
{
    Task<DownloadResult> DownloadAsync(string url, Dictionary<string, string> headers);
    Task<bool> CancelAsync();
    event EventHandler<DownloadProgressEventArgs> ProgressChanged;
}
```

#### SimpleDownloader.cs
**功能:** 简单下载器实现
- 基于HttpClient的下载实现
- 支持断点续传
- 进度监控和报告

### 1.5 工具类集合 (Util/)

#### FilterUtil.cs
**功能:** 流过滤器工具
- 流选择逻辑实现
- 过滤条件解析
- 交互式选择界面

#### MergeUtil.cs  
**功能:** 文件合并工具
- 媒体文件合并
- 支持多种合并方式
- 合并进度监控

#### DownloadUtil.cs
**功能:** 下载工具
- 分段下载管理
- 并发下载控制
- 下载错误处理

#### 其他工具类:
- `ImageHeaderUtil.cs` - 图像头信息处理
- `MediainfoUtil.cs` - 媒体信息获取
- `SubtitleUtil.cs` - 字幕处理
- `PipeUtil.cs` - 管道通信
- `LanguageCodeUtil.cs` - 语言代码处理
- `OtherUtil.cs` - 杂项工具

### 1.6 加密解密模块 (Crypto/)

#### AESUtil.cs
**功能:** AES加密解密工具
- AES-128/CBC模式加解密
- 密钥和IV处理
- 错误处理和安全检查

#### ChaCha20Util.cs
**功能:** ChaCha20加密工具
- ChaCha20流加密实现
- 兼容各种ChaCha20变体
- 高性能流处理

#### CSChaCha20.cs
**功能:** C#实现的ChaCha20
- 纯C#实现的ChaCha20算法
- 避免外部依赖
- 跨平台兼容

### 1.7 URL处理器 (Processor/)

#### DemoProcessor.cs
**功能:** 示例URL处理器
- 演示URL处理流程
- 提供处理模板
- 测试和示例用途

#### NowehoryzontyUrlProcessor.cs
**功能:** 特定网站URL处理器
- 针对nowehoryzonty.pl网站定制
- 特殊URL解析逻辑
- 网站特定需求处理

### 1.8 插件系统 (extend/)

#### PluginManager.cs
**功能:** 插件管理器
- 插件加载和初始化
- 插件生命周期管理
- 插件间通信协调

#### UASwitcherPlugin.cs
**功能:** UA切换插件
- 用户代理字符串管理
- 动态UA切换
- 反爬虫策略支持

#### ProxySwitcherPlugin.cs
**功能:** 代理切换插件
- 代理服务器管理
- 自动代理切换
- 代理池支持

## 2. 公共模块 (N_m3u8DL-RE.Common)

### 2.1 数据实体 (Entity/)

#### StreamSpec.cs
**功能:** 流规格定义
```csharp
public class StreamSpec
{
    public string? Id { get; set; }
    public MediaType? MediaType { get; set; }
    public string? Codecs { get; set; }
    public string? Language { get; set; }
    public string? Resolution { get; set; }
    public long Bandwidth { get; set; }
    public Playlist? Playlist { get; set; }
}
```

#### Playlist.cs
**功能:** 播放列表实体
- 主播放列表和媒体播放列表
- 分段信息管理
- 加密信息存储

#### MediaSegment.cs
**功能:** 媒体分段实体
- 分段URL和时长
- 加密状态和密钥
- 时间戳和序号

### 2.2 枚举类型 (Enum/)

#### ExtractorType.cs
**功能:** 提取器类型枚举
```csharp
public enum ExtractorType
{
    UNKNOWN,
    HTTP_LIVE,    // HLS
    MPEG_DASH,    // DASH
    MSS           // Smooth Streaming
}
```

#### MediaType.cs
**功能:** 媒体类型枚举
- VIDEO - 视频流
- AUDIO - 音频流  
- SUBTITLES - 字幕流

### 2.3 通用工具类 (Util/)

#### HTTPUtil.cs
**功能:** HTTP请求工具
- 统一的HTTP客户端管理
- 请求重试机制
- 响应处理工具

#### RetryUtil.cs
**功能:** 重试工具
- 指数退避重试策略
- 网络请求重试
- 错误类型识别

#### GlobalUtil.cs
**功能:** 全局工具
- 系统路径查找
- 文件操作工具
- 系统信息获取

### 2.4 日志系统 (Log/)

#### Logger.cs
**功能:** 日志记录器
- 多级别日志记录
- 文件和控制台输出
- 彩色日志显示

#### CustomAnsiConsole.cs
**功能:** 自定义控制台
- ANSI转义序列处理
- 跨平台控制台美化
- 进度条和状态显示

### 2.5 资源管理 (Resource/)

#### ResString.cs
**功能:** 资源字符串管理
- 多语言字符串存储
- 动态语言切换
- 字符串格式化

## 3. 解析器模块 (N_m3u8DL-RE.Parser)

### 3.1 流提取器主类 (StreamExtractor.cs)

**核心功能:**
- 统一流提取接口
- 自动格式检测
- 多格式兼容处理

**关键方法:**
- `LoadSourceFromUrlAsync()` - 加载源内容
- `ExtractStreamsAsync()` - 提取流信息
- `FetchPlayListAsync()` - 获取播放列表

### 3.2 提取器实现 (Extractor/)

#### HLSExtractor.cs
**功能:** HLS格式提取器
- M3U8文件解析
- 主播放列表处理
- 媒体播放列表解析

#### DASHExtractor.cs
**功能:** DASH格式提取器
- MPD文件解析
- 自适应流处理
- 分段信息提取

### 3.3 内容处理器 (Processor/)

#### DefaultHLSKeyProcessor.cs
**功能:** HLS密钥处理器
- 密钥URL解析
- 密钥获取和解密
- 密钥缓存管理

#### DefaultHLSContentProcessor.cs
**功能:** HLS内容处理器
- 内容解密处理
- 分段重组
- 错误恢复

## 4. 测试模块 (N_m3u8DL-RE.Tests)

### 4.1 单元测试

#### DASHExtractor2Tests.cs
**功能:** DASH提取器测试
- 解析功能测试
- 边界条件测试
- 错误处理测试

#### HexUtilTests.cs
**功能:** 十六进制工具测试
- 编码解码测试
- 性能测试
- 兼容性测试

### 4.2 测试资源管理

#### ResourceHelper.cs
**功能:** 测试资源助手
- 测试数据管理
- 模拟响应生成
- 测试环境设置

## 模块间依赖关系

### 依赖关系图
```
N_m3u8DL-RE (主程序)
  ├── N_m3u8DL-RE.Parser (解析器) [强依赖]
  └── N_m3u8DL-RE.Common (公共模块) [强依赖]

N_m3u8DL-RE.Parser (解析器)
  └── N_m3u8DL-RE.Common (公共模块) [强依赖]

N_m3u8DL-RE.Tests (测试)
  ├── N_m3u8DL-RE (主程序) [测试依赖]
  ├── N_m3u8DL-RE.Parser (解析器) [测试依赖]
  └── N_m3u8DL-RE.Common (公共模块) [测试依赖]
```

### 数据流关系
1. **配置数据流:** CommandLine → Program → 各模块
2. **解析数据流:** Parser → Common.Entity → DownloadManager
3. **下载数据流:** DownloadManager → Downloader → 文件系统
4. **日志数据流:** 所有模块 → Common.Log → 控制台/文件

## 模块扩展性设计

### 插件扩展点
1. **URL处理器** - 通过Processor接口扩展
2. **下载器实现** - 通过IDownloader接口扩展  
3. **内容处理器** - 通过ContentProcessor接口扩展
4. **加密解密器** - 通过Crypto接口扩展

### 配置扩展性
1. **命令行参数** - 通过MyOption类扩展
2. **解析配置** - 通过ParserConfig类扩展
3. **下载配置** - 通过DownloaderConfig类扩展

这个模块功能详细说明提供了每个模块的完整功能描述，帮助理解项目的架构设计和各模块的职责划分。